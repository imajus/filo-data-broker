---
description: 
globs: contracts/**/*.sol
alwaysApply: false
---
# Smart Contract Architecture & Patterns

## Contract Overview

### NFTFactory Contract Pattern
The **[NFTFactory.sol](mdc:contracts/NFTFactory.sol)** implements a factory pattern for creating NFT collections with integrated payments:

#### Key Features:
- **Collection Creation**: `createCollection()` deploys new NFT contract instances
- **Payment Processing**: Integrated ERC20 token payments with fee splitting
- **FWS Integration**: Direct integration with [FWS Payments](mdc:contracts/fws/payments/Payments.sol)
- **Access Control**: Only collection owners can mint NFTs in their collections
- **Batch Operations**: `batchMintNFTs()` for efficient bulk minting
- **Collection Management**: Toggle active/inactive status, query statistics
- **Balance Management**: Internal balance tracking and withdrawal system
- **Event Logging**: Comprehensive events for indexing and tracking

#### Data Structures:
```solidity
struct Collection {
    address nftContract;
    address owner;
    string name;
    string symbol;
    string description;
    string privateColumns;
    string publicColumns;
    string publicCid;
    string privateCid;
    uint256 price;
    uint256 createdAt;
    bool isActive;
}
```

#### Payment Architecture:
- **Payment Token**: Immutable ERC20 token for all transactions
- **Payments Contract**: Immutable FWS Payments contract reference
- **Fee Structure**: 10% deployer, 10% FWS, 80% collection owner
- **Balance Tracking**: Internal balances with withdrawal mechanism

### NFT Contract Implementation
The **[NFT.sol](mdc:contracts/NFT.sol)** is a custom ERC-721 implementation:

#### Key Features:
- **Full ERC-721 Compliance**: Implements IERC721, IERC721Metadata, IERC165
- **Custom Errors**: Gas-efficient error handling (e.g., `NFT__TokenDoesNotExist`)
- **Owner-Only Minting**: Only contract owner (NFTFactory) can mint
- **Automatic Token URI**: Constructs URIs as `{baseURI}{tokenId}.json`
- **Sequential Token IDs**: Auto-incrementing token ID system

#### Security Patterns:
- **Input Validation**: Checks for zero addresses, existing tokens
- **State Consistency**: Proper balance and ownership tracking
- **Access Control**: `onlyOwner` modifier for critical functions
- **Safe Transfers**: Implements safe transfer checks

### Payment Error Handling
**[NFTFactory.sol](mdc:contracts/NFTFactory.sol)** includes comprehensive payment error handling:

#### Payment Errors:
```solidity
error NFTFactory__InsufficientPayment();    // Buyer lacks token balance
error NFTFactory__InsufficientAllowance();  // Insufficient ERC20 allowance
error NFTFactory__TransferFailed();         // Token transfer failed
error NFTFactory__InsufficientBalance();    // Withdrawal with zero balance
```

#### Purchase Flow Security:
1. **Balance Validation**: Check buyer has sufficient tokens
2. **Allowance Validation**: Verify ERC20 approval amount
3. **Transfer Execution**: Safe token transfer with failure handling
4. **State Updates**: Update balances only after successful transfer
5. **Recovery**: Restore state on transfer failure

## Development Conventions

### Solidity Style:
- **Pragma**: `^0.8.23` for latest features and gas optimizations
- **State Variables**: Prefixed with `s_` (e.g., `s_owners`, `s_balances`)
- **Custom Errors**: Prefixed with contract name (e.g., `NFT__TokenDoesNotExist`)
- **Console Logging**: Uses `hardhat/console.sol` for debugging

### Gas Optimization:
- **Optimizer Enabled**: 1000 runs in [hardhat.config.js](mdc:hardhat.config.js)
- **Batch Operations**: Efficient batch minting with array returns
- **Storage Packing**: Efficient struct layouts
- **Custom Errors**: Instead of revert strings for gas savings

### Testing Considerations:
- **Event Emission**: All critical operations emit events
- **Return Values**: Functions return relevant data for testing
- **State Queries**: Comprehensive getter functions for contract state

## Integration Patterns

### Factory â†’ NFT Communication:
1. Factory creates NFT with specific parameters
2. Factory retains ownership of NFT contract
3. Factory delegates minting permissions
4. Users interact through Factory for most operations

### Metadata & Data Strategy:
- **Base URI**: Set at collection creation (`BASE_TOKEN_URI` constant)
- **Token URI**: `{baseURI}{tokenId}.json` format for NFT metadata
- **Public/Private Data**: Separate CIDs for public and private dataset content
- **IPFS Integration**: Designed for IPFS metadata storage via CIDs
- **CAR Files**: Use [go-generate-car tool](mdc:tools/go-generate-car) for Filecoin storage
- **Column Schema**: Separate tracking of public vs private data columns
- **Data Activation**: Collections become active when CIDs are set via `setCollectionCid()`

### Dataset Marketplace Features:
- **Data Collections**: NFT collections represent datasets with public/private data
- **Access Control**: NFT ownership grants access to private dataset portions
- **Pricing**: Collection owners set purchase price for dataset access
- **Revenue Sharing**: Automatic fee distribution to deployer, FWS, and data owner
